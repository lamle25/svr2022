name: Windows Server 2022 Setup

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-2022

    steps:
      - name: Create Local Administrator
        shell: pwsh
        run: |
          Write-Host "üë§ Creating admin user..."
          $username = "admin"
          $password = ConvertTo-SecureString "Khodoan@135246!" -AsPlainText -Force
          try {
            New-LocalUser -Name $username -Password $password -FullName "Remote Admin" -Description "RDP Access Account"
          } catch {
            Write-Host "‚ö†Ô∏è User already exists ‚Äî continuing..."
          }
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Write-Host "‚úÖ User '$username' added to Administrators."

      - name: Install Remotely Agent
        shell: pwsh
        run: |
          Write-Host "üì¶ Downloading and installing Remotely agent..."
          $url = 'https://remotely.lamrm.tech/api/ClientDownloads/WindowsInstaller/d5f2586b-3579-4c89-99ad-6e855fbc93f0'
          $outfile = "$env:TEMP\Install-Remotely.ps1"
          Invoke-WebRequest -Uri $url -OutFile $outfile -UseBasicParsing
          Write-Host "‚ñ∂Ô∏è Running installer script..."
          Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File `"$outfile`"" -Verb RunAs
          Write-Host "‚úÖ Remotely agent installation triggered."
